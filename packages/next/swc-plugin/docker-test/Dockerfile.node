# Test WASM plugin with Node.js
FROM node:18-alpine

RUN apk add --no-cache file

WORKDIR /test

# Copy the WASM plugin
COPY dist/swc-plugin/gt_wasm_swc_plugin.wasm ./

# Create a simple Node.js test
RUN echo 'const fs = require("fs");' > test.js && \
    echo '' >> test.js && \
    echo 'console.log("=== Testing WASM SWC Plugin ===");' >> test.js && \
    echo '' >> test.js && \
    echo 'const wasmPath = "./gt_wasm_swc_plugin.wasm";' >> test.js && \
    echo 'const wasmBuffer = fs.readFileSync(wasmPath);' >> test.js && \
    echo '' >> test.js && \
    echo 'console.log("File info:");' >> test.js && \
    echo 'console.log(`  Size: ${Math.round(wasmBuffer.length / 1024)} KB`);' >> test.js && \
    echo 'console.log(`  Magic bytes: ${wasmBuffer.slice(0, 4).toString("hex")}`);' >> test.js && \
    echo '' >> test.js && \
    echo '// Check WASM magic number (0x6d736100)' >> test.js && \
    echo 'const expectedMagic = Buffer.from([0x00, 0x61, 0x73, 0x6d]);' >> test.js && \
    echo 'const actualMagic = wasmBuffer.slice(0, 4);' >> test.js && \
    echo '' >> test.js && \
    echo 'if (actualMagic.equals(expectedMagic)) {' >> test.js && \
    echo '  console.log("  ✅ Valid WASM magic number");' >> test.js && \
    echo '  ' >> test.js && \
    echo '  // Validate WASM module' >> test.js && \
    echo '  if (WebAssembly.validate(wasmBuffer)) {' >> test.js && \
    echo '    console.log("  ✅ WASM module is valid");' >> test.js && \
    echo '    console.log("✅ WASM plugin validated");' >> test.js && \
    echo '  } else {' >> test.js && \
    echo '    console.log("  ❌ WASM validation failed");' >> test.js && \
    echo '    process.exit(1);' >> test.js && \
    echo '  }' >> test.js && \
    echo '} else {' >> test.js && \
    echo '  console.log("  ❌ Invalid WASM magic number");' >> test.js && \
    echo '  process.exit(1);' >> test.js && \
    echo '}'>> test.js

CMD ["node", "test.js"]