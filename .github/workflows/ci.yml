name: CI - Run Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "packages/*/CHANGELOG.md"
      - "packages/*/package.json"
      - ".changeset/**"

env:
  CI: true
permissions:
  contents: read

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Install dependencies
        run: pnpm install --filter='...[origin/${{ github.base_ref }}]'

      - name: Rebuild packages
        run: pnpm rebuild

      - name: Run lint
        run: pnpm exec turbo lint --filter='...[origin/${{ github.base_ref }}]'

      - name: Build packages
        run: pnpm exec turbo build --filter='...[origin/${{ github.base_ref }}]'

      - name: Run tests
        run: pnpm exec turbo test --filter='...[origin/${{ github.base_ref }}]'

  test-builds:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        node: [20, 24]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm

      - name: Check if gt-next changed
        id: gt_next_changed
        shell: bash
        run: |
          if pnpm exec turbo build --filter='gt-next...[origin/${{ github.base_ref }}]' --dry=json | jq -e '.packages | length > 0' > /dev/null 2>&1; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      - name: Setup Node.js
        if: steps.gt_next_changed.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "pnpm"
      - name: Setup Rust
        if: steps.gt_next_changed.outputs.changed == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Install dependencies
        if: steps.gt_next_changed.outputs.changed == 'true'
        run: pnpm install --filter='gt-next...[origin/${{ github.base_ref }}]'

      - name: Test Builds
        if: steps.gt_next_changed.outputs.changed == 'true'
        run: |
          pnpm exec turbo build --filter=base...
          pnpm exec turbo build:turbopack --filter=base...

          pnpm exec turbo build --filter=general-cases...
          pnpm exec turbo build:turbopack --filter=general-cases...

  run-tests:
    needs: [tests, test-builds]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All tests passed"
